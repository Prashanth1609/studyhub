{% extends "core/base.html" %}

{% block title %}{{ session.title }} Â· StudyHub{% endblock %}

{% block content %}
<div class="session-detail-container">
    <div class="session-header">
        <h1>{{ session.title }}</h1>
        <div class="session-meta">
            <span class="session-type {% if session.is_virtual %}virtual{% else %}in-person{% endif %}">
                {% if session.is_virtual %}Virtual{% else %}In-Person{% endif %}
            </span>
            <span class="session-capacity">{{ session.num_members }}/{{ session.capacity }} joined</span>
        </div>
    </div>

    <div class="session-info">
        <div class="info-section">
            <h3>Session Details</h3>
            <p><strong>When:</strong> {{ session.start_time|date:"M d, Y H:i" }}{% if session.end_time %} - {{ session.end_time|date:"H:i" }}{% endif %}</p>
            <p><strong>Host:</strong> {{ session.owner.username }}</p>
            {% if session.is_virtual and session.virtual_link %}
                <p><strong>Meeting Link:</strong> <a href="{{ session.virtual_link }}" target="_blank" class="btn btn-link">Join Meeting</a></p>
            {% elif not session.is_virtual and session.location_text %}
                <p><strong>Location:</strong> {{ session.location_text }}</p>
            {% endif %}
            {% if session.subjects.all %}
                <div class="subjects">
                    <strong>Subjects:</strong>
                    {% for tag in session.subjects.all %}
                        <span class="subject-tag">{{ tag.name }}</span>
                    {% endfor %}
                </div>
            {% endif %}
            {% if session.description %}
                <div class="description">
                    <h4>Description</h4>
                    <p>{{ session.description }}</p>
                </div>
            {% endif %}
            <a href="{% url 'core:calendar' session.pk %}" class="btn btn-outline-primary mt-3"><i class="fas fa-calendar-plus me-2"></i>Download Calendar</a>
        </div>

        <!-- Join/Leave Actions -->
        <div class="session-actions">
            {% if request.user.is_authenticated %}
                {% if is_member %}
                    <form method="post" action="{% url 'core:leave' session.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Leave Session</button>
                    </form>
                {% else %}
                    {% if spots_left > 0 %}
                        <form method="post" action="{% url 'core:join' session.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">Join Session</button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'core:waitlist' session.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning">Join Waitlist</button>
                        </form>
                        <p class="session-full mt-2"><small>Session is full. You can join the waitlist above.</small></p>
                    {% endif %}
                {% endif %}
            {% else %}
                <p><a href="{% url 'admin:login' %}">Login to join this session</a></p>
            {% endif %}
        </div>
    </div>

    <!-- Members Section -->
    <div class="members-section">
        <h3>Members ({{ session.num_members }})</h3>
        <div class="members-list">
            {% for member in members %}
                <div class="member">
                    <span class="member-name">{{ member.username }}</span>
                    {% if member == session.owner %}
                        <span class="member-role host">Host</span>
                    {% endif %}
                </div>
            {% empty %}
                <p>No members yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Waitlist Section (Only visible to session owner) -->
    {% if request.user == session.owner and waitlist %}
    <div class="waitlist-section">
        <h3>Waitlist ({{ waitlist.count }})</h3>
        <div class="waitlist-list">
            {% for entry in waitlist %}
                <div class="waitlist-entry">
                    <span class="waitlist-name">{{ entry.user.username }}</span>
                    <span class="waitlist-time">{{ entry.added_at|date:"M d H:i" }}</span>
                </div>
            {% empty %}
                <p>No one on the waitlist.</p>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Messages Section -->
    <div class="messages-section">
        <h3>Messages</h3>
        <div class="messages-list">
            {% for message in messages %}
                <div class="message">
                    <div class="message-header">
                        <span class="message-author">{{ message.user.username }}</span>
                        <span class="message-time">{{ message.created_at|date:"M d H:i" }}</span>
                    </div>
                    <div class="message-content">
                        {{ message.text }}
                    </div>
                </div>
            {% empty %}
                <p>No messages yet.</p>
            {% endfor %}
        </div>
        
        {% if request.user.is_authenticated and is_member %}
            <form method="post" action="{% url 'core:detail' session.pk %}" class="message-form">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="message_text" placeholder="Type your message..." required></textarea>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}